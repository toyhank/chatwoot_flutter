# 🚀 Chatwoot 集成测试指南

## 当前配置

- **服务器地址**: `http://43.132.120.194:3000`
- **Website Token**: `mYm3V3bEheaSb6GpSHvKKLUn`

---

## 📝 测试步骤

### 步骤 1：测试 Chatwoot 服务器连接

#### 方法 A：使用提供的诊断工具（推荐）

1. 用浏览器打开项目根目录下的 `test_chatwoot.html` 文件
2. 查看三个测试的结果：
   - ✓ 测试 1: 服务器可达性
   - ✓ 测试 2: SDK 脚本加载  
   - ✓ 测试 3: SDK 初始化
3. 如果所有测试都通过，聊天窗口应该出现在页面右下角
4. 如果有测试失败，查看 `CHATWOOT_TROUBLESHOOTING.md` 文档

#### 方法 B：手动测试服务器

在浏览器中访问：
```
http://43.132.120.194:3000
```

如果能看到 Chatwoot 登录页面，说明服务器运行正常。

---

### 步骤 2：检查 Chatwoot 后台配置

1. **登录 Chatwoot 后台**：
   ```
   http://43.132.120.194:3000
   ```

2. **验证 Website Token**：
   - 进入 `Settings` → `Inboxes`
   - 选择您的 Website Inbox
   - 进入 `Configuration` → `Widget Configuration`
   - 确认 Website Token 是否为：`mYm3V3bEheaSb6GpSHvKKLUn`

3. **检查 Inbox 状态**：
   - 确保 Inbox 已启用
   - 确保有客服人员在线

---

### 步骤 3：测试 Flutter 应用

#### Web 平台测试

```bash
cd G:\HBuilderProjects\testcrm_flutter
flutter run -d chrome --web-browser-flag "--disable-web-security"
```

**注意**：`--disable-web-security` 是为了临时禁用 CORS 限制，方便测试。

#### Android 平台测试

```bash
flutter run -d android
```

#### 测试步骤：

1. 启动应用
2. 导航到"客服"页面
3. 观察是否能看到聊天界面
4. 检查是否显示"已离线"或"在线"

---

## 🐛 常见问题及快速修复

### 问题 1: 显示"已离线"

**可能原因**：
- Chatwoot 服务器无法访问
- CORS 跨域问题
- WebSocket 连接失败
- 没有客服人员在线

**快速检查**：
1. 打开 `test_chatwoot.html` 看哪个测试失败
2. 查看浏览器控制台（F12）的错误信息
3. 确认 Chatwoot 后台有客服在线

**详细解决方案**：查看 `CHATWOOT_TROUBLESHOOTING.md`

---

### 问题 2: Web 平台加载失败

**解决方案**：使用禁用安全模式运行

```bash
flutter run -d chrome --web-browser-flag "--disable-web-security"
```

这是因为 HTTP 服务器在 HTTPS 页面中加载会被浏览器阻止。

**长期解决方案**：为 Chatwoot 服务器配置 HTTPS（见故障排查文档）

---

### 问题 3: Android 无法加载

**检查清单**：
1. ✅ `android:usesCleartextTraffic="true"` 已配置（已完成）
2. ✅ 设备已连接互联网
3. ✅ 可以 ping 通 `43.132.120.194`

---

### 问题 4: WebSocket 连接失败

**症状**：SDK 加载成功但一直显示"连接中"或"已离线"

**检查**：
1. 浏览器控制台是否有 WebSocket 错误
2. Chatwoot 服务器的 ActionCable 配置
3. 防火墙是否阻止 WebSocket

---

## 📋 调试清单

在报告问题前，请完成以下检查：

- [ ] ✅ 服务器能 ping 通：`ping 43.132.120.194`
- [ ] ✅ 浏览器能访问：`http://43.132.120.194:3000`
- [ ] ✅ 诊断工具测试通过：打开 `test_chatwoot.html`
- [ ] ✅ Website Token 正确：`mYm3V3bEheaSb6GpSHvKKLUn`
- [ ] ✅ Chatwoot 后台有客服在线
- [ ] ✅ 浏览器控制台无 CORS 错误
- [ ] ✅ WebSocket 连接成功

---

## 🔗 相关文件

- `test_chatwoot.html` - Chatwoot 连接诊断工具
- `CHATWOOT_TROUBLESHOOTING.md` - 详细故障排查指南
- `CHATWOOT_WEBVIEW_GUIDE.md` - WebView 集成完整文档
- `CHATWOOT_SETUP_GUIDE.md` - Chatwoot 设置指南
- `WEB_DEPLOYMENT_GUIDE.md` - Web 部署指南

---

## 🆘 获取帮助

如果问题仍未解决，请提供：

1. `test_chatwoot.html` 的测试结果截图
2. 浏览器控制台（F12）的完整错误信息
3. 问题的详细描述（什么平台、什么操作、什么现象）

---

## 📚 下一步

一旦连接成功，您可以：

1. **自定义聊天窗口外观** - 修改 `customer_service_page.dart` 中的 HTML/CSS
2. **设置用户信息自动识别** - 在用户登录后保存 userId、userName、userEmail
3. **配置 HTTPS** - 按照故障排查文档配置 SSL 证书
4. **部署到生产环境** - 查看 `WEB_DEPLOYMENT_GUIDE.md`

---

**祝您使用愉快！** 🎉

