<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>åœ¨çº¿å®¢æœ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    
    /* èŠå¤©å®¹å™¨ */
    #chatwoot-container {
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.3s;
    }
    
    #loading.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(180, 230, 102, 0.3);
      border-top-color: #B4E666;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #loading-text {
      color: #B4E666;
      margin-top: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div id="loading-text">æ­£åœ¨è¿æ¥å®¢æœ...</div>
  </div>
  
  <div id="chatwoot-container"></div>

  <script>
    // é…ç½®ä¿¡æ¯ï¼ˆå°†è¢« Flutter æ›¿æ¢ï¼‰
    const CONFIG = {
      baseUrl: 'CHATWOOT_BASE_URL',
      websiteToken: 'CHATWOOT_TOKEN',
      userId: 'USER_ID',
      userName: 'USER_NAME',
      userEmail: 'USER_EMAIL',
      // å‰ç«¯æµ‹è¯•ç”¨ HMAC Tokenï¼Œç”Ÿäº§è¯·æ”¹ä¸ºåç«¯ç”Ÿæˆ hash
      hmacToken: 'CHATWOOT_HMAC_TOKEN'
    };
    
    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const prefix = {
        info: 'ğŸ“˜',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸'
      }[type] || 'â„¹ï¸';
      
      console.log(`${prefix} ${message}`);
      
      // å‘é€åˆ° Flutter
      if (window.FlutterLog) {
        try {
          window.FlutterLog.postMessage(`${type.toUpperCase()}: ${message}`);
        } catch (e) {
          console.error('Failed to send to Flutter:', e);
        }
      }
    }
    
    // éšè—åŠ è½½åŠ¨ç”»
    function hideLoading() {
      const loading = document.getElementById('loading');
      if (loading) {
        setTimeout(() => {
          loading.classList.add('hidden');
        }, 500);
      }
    }
    
    // æ›´æ–°åŠ è½½æ–‡æœ¬
    function updateLoadingText(text) {
      const elem = document.getElementById('loading-text');
      if (elem) elem.textContent = text;
    }
    
    // ä½¿ç”¨æµè§ˆå™¨ Web Crypto ç”Ÿæˆ HMAC-SHA256ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰
    async function generateHMAC(key, message) {
      if (!window.crypto?.subtle) {
        throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒ Web Crypto');
      }
      const encoder = new TextEncoder();
      const cryptoKey = await crypto.subtle.importKey(
        'raw',
        encoder.encode(key),
        { name: 'HMAC', hash: 'SHA-256' },
        false,
        ['sign']
      );
      const signature = await crypto.subtle.sign('HMAC', cryptoKey, encoder.encode(message));
      return Array.from(new Uint8Array(signature))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }
    
    // åˆå§‹åŒ– Chatwoot
    function initChatwoot() {
      log('ğŸš€ å¼€å§‹åˆå§‹åŒ– Chatwoot Mobile');
      log('é…ç½®: ' + JSON.stringify(CONFIG));
      
      try {
        updateLoadingText('åŠ è½½ Chatwoot SDK...');
        
        // æ ‡å‡† Chatwoot SDK åˆå§‹åŒ–
        (function(d, t) {
          var BASE_URL = CONFIG.baseUrl;
          var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
          g.src = BASE_URL + "/packs/js/sdk.js";
          g.defer = true;
          g.async = true;
          
          g.onload = function() {
            log('âœ… Chatwoot SDK åŠ è½½æˆåŠŸ', 'success');
            updateLoadingText('åˆå§‹åŒ–å®¢æœç³»ç»Ÿ...');
            
            try {
              // è¿è¡Œ Chatwoot SDK
              window.chatwootSDK.run({
                websiteToken: CONFIG.websiteToken,
                baseUrl: CONFIG.baseUrl
              });
              log('âœ… Chatwoot SDK è¿è¡ŒæˆåŠŸ', 'success');
              
              // ç­‰å¾… Chatwoot å°±ç»ª
              window.addEventListener('chatwoot:ready', async function() {
                log('âœ… Chatwoot å°±ç»ªäº‹ä»¶è§¦å‘', 'success');
                updateLoadingText('è®¾ç½®ç”¨æˆ·ä¿¡æ¯...');
                
                try {
                  const userData = {
                    name: CONFIG.userName,
                    email: CONFIG.userEmail
                  };
                  
                  // å‰ç«¯ç”Ÿæˆ identifier_hash ä»…ç”¨äºæµ‹è¯•ï¼Œç”Ÿäº§è¯·æ”¹åç«¯ç”Ÿæˆ
                  if (CONFIG.hmacToken && CONFIG.hmacToken !== 'CHATWOOT_HMAC_TOKEN') {
                    try {
                      userData.identifier_hash = await generateHMAC(CONFIG.hmacToken, CONFIG.userId);
                      log('ğŸ” å·²ç”Ÿæˆå‰ç«¯ HMAC identifier_hash', 'success');
                    } catch (hashErr) {
                      log('âš ï¸ ç”Ÿæˆ HMAC å¤±è´¥ï¼ˆç»§ç»­æ— é‰´æƒï¼‰: ' + hashErr.message, 'warning');
                    }
                  }
                  
                  // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
                  window.$chatwoot.setUser(CONFIG.userId, userData);
                  log('ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯å·²è®¾ç½®: ' + CONFIG.userName, 'success');
                  
                  // è®¾ç½®è¯­è¨€
                  window.$chatwoot.setLocale('zh_CN');
                  log('ğŸŒ è¯­è¨€å·²è®¾ç½®ä¸ºä¸­æ–‡', 'success');
                  
                  // è‡ªåŠ¨æ‰“å¼€èŠå¤©çª—å£
                  setTimeout(function() {
                    window.$chatwoot.toggle('open');
                    log('ğŸ’¬ èŠå¤©çª—å£å·²æ‰“å¼€', 'success');
                    hideLoading();
                  }, 500);
                  
                } catch (e) {
                  log('âŒ è®¾ç½®ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + e.message, 'error');
                  hideLoading();
                }
              });
              
              // ç›‘å¬é”™è¯¯äº‹ä»¶
              window.addEventListener('chatwoot:error', function(error) {
                log('âŒ Chatwoot é”™è¯¯: ' + JSON.stringify(error), 'error');
              });
              
            } catch (e) {
              log('âŒ è¿è¡Œ Chatwoot SDK å¤±è´¥: ' + e.message, 'error');
              hideLoading();
            }
          };
          
          g.onerror = function(error) {
            log('âŒ SDK åŠ è½½å¤±è´¥: ' + error, 'error');
            updateLoadingText('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            setTimeout(hideLoading, 2000);
          };
          
          s.parentNode.insertBefore(g, s);
          log('ğŸ“¦ SDK è„šæœ¬å·²æ’å…¥', 'info');
          
        })(document, "script");
        
      } catch (e) {
        log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
        hideLoading();
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initChatwoot);
    } else {
      initChatwoot();
    }
    
    // å…¨å±€é”™è¯¯æ•è·
    window.addEventListener('error', function(event) {
      log('å…¨å±€é”™è¯¯: ' + event.message, 'error');
    });
    
    // ç›‘å¬æ¶ˆæ¯äº‹ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼‰
    if (window.addEventListener) {
      window.addEventListener('message', function(e) {
        log('æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶: ' + JSON.stringify(e.data), 'info');
      }, false);
    }
  </script>
</body>
</html>







